<div class="ngx-phone-number-container" [ngClass]="containerClass">
  <div class="input-wrapper" #phoneWrapperRef>
    <!-- 📦 Input Group: Country Selector (optional) + Input -->
    <div class="input-group" [class.separate]="separateCountrySelector">
      <!-- Country Selector BEFORE Input -->
      <button
        *ngIf="separateCountrySelector && countrySelectPosition === 'before'"
        class="country-selector-btn"
        type="button"
        [disabled]="disabled || lockCountrySelection"
        (click)="!lockCountrySelection && toggleDropdown()"
        [attr.aria-label]="
          'Select country: ' + (selectedCountry?.name || 'None')
        "
        [attr.aria-expanded]="showDropdown"
      >
        <span class="country-flag" *ngIf="showFlags && selectedCountry">
          {{ getEmojiFlag(selectedCountry.iso2) }}
        </span>
        <span class="country-code" *ngIf="showDialCode">
          {{ selectedCountry?.dialCode || "+1" }}
        </span>
        <svg
          *ngIf="!lockCountrySelection"
          class="dropdown-arrow"
          viewBox="0 0 12 8"
        >
          <path
            d="M1 1l5 5 5-5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
          />
        </svg>
      </button>

      <!-- Phone Input with Inline Flag -->
      <div class="input-container" [class.has-error]="hasError">
        <button
          *ngIf="!separateCountrySelector && showFlags"
          type="button"
          class="flag-trigger"
          [ngClass]="buttonClass"
          [disabled]="disabled || lockCountrySelection"
          (click)="!lockCountrySelection && toggleDropdown()"
          [attr.aria-label]="
            'Selected country: ' + (selectedCountry?.name || 'None')
          "
        >
          <span class="country-flag" *ngIf="selectedCountry">
            {{ getEmojiFlag(selectedCountry.iso2) }}
          </span>
          <svg
            *ngIf="!lockCountrySelection"
            class="arrow-icon"
            viewBox="0 0 12 8"
          >
            <path
              d="M1 1l5 5 5-5"
              stroke="currentColor"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
            />
          </svg>
        </button>

        <input
          #phoneInput
          type="tel"
          class="phone-input"
          [ngClass]="inputClass"
          [(ngModel)]="phoneValue"
          (ngModelChange)="onPhoneInput($event)"
          [placeholder]="placeholder"
          [disabled]="disabled"
          [readonly]="readonly"
          [required]="required"
          autocomplete="tel"
          (focus)="onPhoneFocus()"
          (blur)="onPhoneBlur()"
          (keydown.enter)="onEnterKey()"
          [attr.aria-label]="'Phone number input'"
          [attr.aria-invalid]="hasError"
        />
      </div>

      <!-- Country Selector AFTER Input -->
      <button
        *ngIf="separateCountrySelector && countrySelectPosition === 'after'"
        class="country-selector-btn"
        [ngClass]="buttonClass"
        type="button"
        [disabled]="disabled || lockCountrySelection"
        (click)="!lockCountrySelection && toggleDropdown()"
        [attr.aria-label]="
          'Select country: ' + (selectedCountry?.name || 'None')
        "
        [attr.aria-expanded]="showDropdown"
      >
        <span class="country-flag" *ngIf="showFlags && selectedCountry">
          {{ getEmojiFlag(selectedCountry.iso2) }}
        </span>
        <span class="country-code" *ngIf="showDialCode">
          {{ selectedCountry?.dialCode || "+1" }}
        </span>
        <svg
          *ngIf="!lockCountrySelection"
          class="dropdown-arrow"
          viewBox="0 0 12 8"
        >
          <path
            d="M1 1l5 5 5-5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
          />
        </svg>
      </button>
    </div>

    <!-- 🌍 Country Dropdown -->
    <div
      *ngIf="showDropdown"
      #dropdownRef
      class="country-dropdown"
      [ngClass]="[
        dropdownPosition === 'top' ? 'dropdown--top' : 'dropdown--bottom',
        dropdownClass
      ]"
      [style.max-height]="dropdownMaxHeight"
      [style.width]="dropdownWidth"
      role="listbox"
      [attr.aria-label]="'Country selection'"
    >
      <!-- 🔍 Search -->
      <div *ngIf="searchEnabled" class="search-container">
        <input
          #searchInput
          type="text"
          class="search-input"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange($event)"
          [placeholder]="searchPlaceholder"
          [attr.aria-label]="'Search countries'"
        />
      </div>

      <!-- Country List -->
      <div class="country-list">
        <div *ngIf="preferredCountriesList.length > 0">
          <div class="section-label">Suggested</div>
          <button
            *ngFor="let country of preferredCountriesList"
            class="country-item"
            [class.selected]="country.iso2 === selectedCountry?.iso2"
            (click)="selectCountryAndClose(country)"
          >
            <span class="country-flag">{{ getEmojiFlag(country.iso2) }}</span>
            <span class="country-name">{{ country.name }}</span>
            <span class="country-code">{{ country.dialCode }}</span>
          </button>
          <hr class="list-divider" />
        </div>

        <button
          *ngFor="let country of filteredCountries"
          class="country-item"
          [class.selected]="country.iso2 === selectedCountry?.iso2"
          (click)="selectCountryAndClose(country)"
        >
          <span class="country-flag">{{ getEmojiFlag(country.iso2) }}</span>
          <span class="country-name">{{ country.name }}</span>
          <span class="country-code">{{ country.dialCode }}</span>
        </button>

        <div class="no-results" *ngIf="filteredCountries.length === 0">
          <p>{{ noResultsText }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ❌ Validation Error -->
  <div *ngIf="showErrorMessages && shouldShowError()" [ngClass]="['error-message', errorClass]">
    <span>{{ validationResult?.error?.message }}</span>
  </div>

  <!-- 🔲 Overlay to close dropdown -->
  <div
    class="dropdown-overlay"
    *ngIf="showDropdown"
    (click)="closeDropdown()"
  ></div>
</div>
