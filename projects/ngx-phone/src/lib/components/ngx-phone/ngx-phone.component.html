<div
  class="ngx-phone-container"
  [ngClass]="normalizedConfig.containerClass"
  [style]="getContainerStyles()"
>
  <!-- 🏷️ Label (if enabled) -->
  <label
    *ngIf="normalizedConfig.showLabel && normalizedConfig.label"
    [ngClass]="['phone-input-label', normalizedConfig.labelClass]"
    [class.floating]="normalizedConfig.labelPosition === 'floating'"
    [class.inline]="normalizedConfig.labelPosition === 'inline'"
    [for]="inputId"
  >
    {{ normalizedConfig.label }}
    <span *ngIf="required" class="required-asterisk">*</span>
  </label>

  <div class="input-wrapper" #phoneWrapperRef>
    <!-- 📦 Input Group: Country Selector (optional) + Input -->
    <div
      class="input-group"
      [class.separate]="normalizedConfig.separateCountrySelector"
      [class.has-error]="hasError"
      [class.focused]="isFocused"
      [class.disabled]="disabled"
    >
      <!-- Country Selector BEFORE Input -->
      <button
        *ngIf="
          normalizedConfig.separateCountrySelector &&
          normalizedConfig.countrySelectPosition === 'before'
        "
        class="country-selector-btn"
        [ngClass]="normalizedConfig.buttonClass"
        type="button"
        [disabled]="disabled || normalizedConfig.lockCountrySelection"
        (click)="!normalizedConfig.lockCountrySelection && toggleDropdown()"
        [attr.aria-label]="
          'Select country: ' + (selectedCountry?.name || 'None')
        "
        [attr.aria-expanded]="showDropdown"
      >
        <span
          class="country-flag"
          *ngIf="normalizedConfig.showFlags && selectedCountry"
          [class]="getFlagClasses()"
        >
          <span
            [innerHTML]="getEmojiFlag(selectedCountry.iso2)"
            [class.flag-emoji]="
              !isImageFlag(getEmojiFlag(selectedCountry.iso2))
            "
            [class.flag-image]="isImageFlag(getEmojiFlag(selectedCountry.iso2))"
          ></span>
        </span>
        <span class="country-code" *ngIf="normalizedConfig.showDialCode">
          {{ selectedCountry?.dialCode || "+1" }}
        </span>
        <svg
          *ngIf="!normalizedConfig.lockCountrySelection"
          class="dropdown-arrow"
          viewBox="0 0 12 8"
        >
          <path
            d="M1 1l5 5 5-5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
          />
        </svg>
      </button>

      <!-- Phone Input with Inline Flag -->
      <div
        class="input-container"
        [class.has-error]="hasError"
        [class.custom-border]="normalizedConfig.customContainerBorder"
      >
        <!-- Inline Flag Button (when not using separate selector) -->
        <button
          *ngIf="shouldShowInlineFlag()"
          type="button"
          class="flag-trigger"
          [ngClass]="normalizedConfig.buttonClass"
          [class]="getFlagClasses()"
          [disabled]="disabled || normalizedConfig.lockCountrySelection"
          (click)="!normalizedConfig.lockCountrySelection && toggleDropdown()"
          [attr.aria-label]="
            'Selected country: ' + (selectedCountry?.name || 'None')
          "
          [attr.aria-expanded]="showDropdown"
        >
          <span class="country-flag" *ngIf="selectedCountry">
            <span
              [innerHTML]="getEmojiFlag(selectedCountry.iso2)"
              [class.flag-emoji]="
                !isImageFlag(getEmojiFlag(selectedCountry.iso2))
              "
              [class.flag-image]="
                isImageFlag(getEmojiFlag(selectedCountry.iso2))
              "
            ></span>
          </span>
          <svg
            *ngIf="!normalizedConfig.lockCountrySelection"
            class="arrow-icon"
            viewBox="0 0 12 8"
          >
            <path
              d="M1 1l5 5 5-5"
              stroke="currentColor"
              stroke-width="2"
              fill="none"
              stroke-linecap="round"
            />
          </svg>
        </button>

        <input
          #phoneInput
          [id]="inputId"
          type="tel"
          class="phone-input"
          [ngClass]="[
            normalizedConfig.inputClass,
            normalizedConfig.placeholderClass
          ]"
          [style]="getPlaceholderStyles()"
          [value]="phoneValue"
          (input)="onPhoneInput($any($event.target).value)"
          [placeholder]="getEffectivePlaceholder()"
          [disabled]="disabled"
          [readonly]="readonly"
          [required]="required"
          autocomplete="tel"
          (focus)="onPhoneFocus()"
          (blur)="onPhoneBlur()"
          (keydown.enter)="onEnterKey()"
          [attr.aria-label]="'Phone number input'"
          [attr.aria-invalid]="shouldShowError()"
          [attr.aria-describedby]="shouldShowError() ? errorId : null"
        />
      </div>

      <!-- Country Selector AFTER Input -->
      <button
        *ngIf="
          normalizedConfig.separateCountrySelector &&
          normalizedConfig.countrySelectPosition === 'after'
        "
        class="country-selector-btn"
        [ngClass]="normalizedConfig.buttonClass"
        type="button"
        [disabled]="disabled || normalizedConfig.lockCountrySelection"
        (click)="!normalizedConfig.lockCountrySelection && toggleDropdown()"
        [attr.aria-label]="
          'Select country: ' + (selectedCountry?.name || 'None')
        "
        [attr.aria-expanded]="showDropdown"
      >
        <span
          class="country-flag"
          *ngIf="normalizedConfig.showFlags && selectedCountry"
          [class]="getFlagClasses()"
        >
          <span
            [innerHTML]="getEmojiFlag(selectedCountry.iso2)"
            [class.flag-emoji]="
              !isImageFlag(getEmojiFlag(selectedCountry.iso2))
            "
            [class.flag-image]="isImageFlag(getEmojiFlag(selectedCountry.iso2))"
          ></span>
        </span>
        <span class="country-code" *ngIf="normalizedConfig.showDialCode">
          {{ selectedCountry?.dialCode || "+1" }}
        </span>
        <svg
          *ngIf="!normalizedConfig.lockCountrySelection"
          class="dropdown-arrow"
          viewBox="0 0 12 8"
        >
          <path
            d="M1 1l5 5 5-5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
          />
        </svg>
      </button>
    </div>

    <!-- 🌍 Country Dropdown -->
    <div
      *ngIf="showDropdown"
      #dropdownRef
      class="country-dropdown"
      [ngClass]="getDropdownClasses()"
      [style.max-height]="normalizedConfig.dropdownMaxHeight"
      [style.width]="normalizedConfig.dropdownWidth"
      [style]="getDropdownStyles()"
      role="listbox"
      [attr.aria-label]="'Country selection'"
    >
      <!-- 🔍 Search -->
      <div *ngIf="normalizedConfig.searchEnabled" class="search-container">
        <input
          #searchInput
          type="text"
          class="search-input"
          [value]="searchQuery"
          (input)="onSearchChange($any($event.target).value)"
          [placeholder]="normalizedConfig.searchPlaceholder"
          [attr.aria-label]="'Search countries'"
        />
      </div>

      <!-- Country List -->
      <div class="country-list">
        <div *ngIf="preferredCountriesList.length > 0">
          <div class="section-label">Suggested</div>
          <button
            *ngFor="let country of preferredCountriesList; trackBy: trackByIso"
            class="country-item"
            [class.selected]="country.iso2 === selectedCountry?.iso2"
            (click)="selectCountryAndClose(country)"
            type="button"
          >
            <span class="country-flag">
              <span
                [innerHTML]="getEmojiFlag(country.iso2)"
                [class.flag-emoji]="!isImageFlag(getEmojiFlag(country.iso2))"
                [class.flag-image]="isImageFlag(getEmojiFlag(country.iso2))"
              ></span>
            </span>
            <span class="country-name">{{ country.name }}</span>
            <span class="country-code">{{ country.dialCode }}</span>
          </button>
          <hr class="list-divider" />
        </div>

        <button
          *ngFor="let country of filteredCountries; trackBy: trackByIso"
          class="country-item"
          [class.selected]="country.iso2 === selectedCountry?.iso2"
          (click)="selectCountryAndClose(country)"
          type="button"
        >
          <span class="country-flag">
            <span
              [innerHTML]="getEmojiFlag(country.iso2)"
              [class.flag-emoji]="!isImageFlag(getEmojiFlag(country.iso2))"
              [class.flag-image]="isImageFlag(getEmojiFlag(country.iso2))"
            ></span>
          </span>
          <span class="country-name">{{ country.name }}</span>
          <span class="country-code">{{ country.dialCode }}</span>
        </button>

        <div class="no-results" *ngIf="filteredCountries.length === 0">
          <p>{{ normalizedConfig.noResultsText }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ❌ Validation Error -->
  <div
    *ngIf="normalizedConfig.showErrorMessages && shouldShowError()"
    [ngClass]="['error-message', normalizedConfig.errorClass]"
    [id]="errorId"
    role="alert"
    [attr.aria-live]="'polite'"
  >
    <span>{{ displayedError?.message }}</span>
  </div>

  <!-- 🔲 Overlay to close dropdown -->
  <div
    class="dropdown-overlay"
    *ngIf="showDropdown"
    (click)="closeDropdown()"
  ></div>
</div>
